---
title: "hill-function-batch"
author: "Nobuaki Masaki"
date: "21 August 2019"
output: html_document
---

```{r}
#This code is used to create plots after all of the hill-function-batch...R files are run to generate the data needed for the plots. Note that x and y in the code refer to x_2 and x_1 respectively in the paper.

library(tidyverse)
library(data.table)
library(parallel)
```

```{r}
#This chunk does not have to be run the second time as the result of this chunk is already written to a csv file that is read in the next chunk.

#This function recovers the parameters of the Markov chain used to generate the stationary distribution from the csv. file. This is done because the data used to generate the heatmaps only contains the file name as the id. 
return_data_params <- function(file) {
    
  file_split <- strsplit(as.character(file), "_")[[1]]
  true_n <- file_split[3]
  true_K <- file_split[5]
  y_bar <- file_split[7]
  gamma <- file_split[9]
  x_bar <- file_split[11]
  
  return(list(true_n, true_K, x_bar, y_bar, gamma))
}

#data generated from hill-function-batch_1.R
n_1 <- read.csv("hill-function-batch_n_1.csv")

#calls previous function to obtain parameter values
param_list <- lapply(n_1$file, return_data_params)
param_list <- t(matrix(unlist(param_list), nrow=length(unlist(param_list[1]))))

n_1$true_n <- param_list[ ,1]
n_1$true_K <- param_list[,2]
n_1$x_bar <- param_list[,3]
n_1$y_bar <- param_list[,4]
n_1$gamma <- param_list[,5]

n_2 <- read.csv("hill-function-batch_n_2.csv")

param_list <- lapply(n_2$file, return_data_params)
param_list <- t(matrix(unlist(param_list), nrow=length(unlist(param_list[1]))))

n_2$true_n <- param_list[ ,1]
n_2$true_K <- param_list[,2]
n_2$x_bar <- param_list[,3]
n_2$y_bar <- param_list[,4]
n_2$gamma <- param_list[,5]

n_3 <- read.csv("hill-function-batch_n_3.csv")

param_list <- lapply(n_3$file, return_data_params)
param_list <- t(matrix(unlist(param_list), nrow=length(unlist(param_list[1]))))

n_3$true_n <- param_list[ ,1]
n_3$true_K <- param_list[,2]
n_3$x_bar <- param_list[,3]
n_3$y_bar <- param_list[,4]
n_3$gamma <- param_list[,5]

n_4 <- read.csv("hill-function-batch_n_4.csv")

param_list <- lapply(n_4$file, return_data_params)
param_list <- t(matrix(unlist(param_list), nrow=length(unlist(param_list[1]))))

n_4$true_n <- param_list[ ,1]
n_4$true_K <- param_list[,2]
n_4$x_bar <- param_list[,3]
n_4$y_bar <- param_list[,4]
n_4$gamma <- param_list[,5]

n_5 <- read.csv("hill-function-batch_n_5.csv")

param_list <- lapply(n_5$file, return_data_params)
param_list <- t(matrix(unlist(param_list), nrow=length(unlist(param_list[1]))))

n_5$true_n <- param_list[ ,1]
n_5$true_K <- param_list[,2]
n_5$x_bar <- param_list[,3]
n_5$y_bar <- param_list[,4]
n_5$gamma <- param_list[,5]

n_6 <- read.csv("hill-function-batch_n_6.csv")

param_list <- lapply(n_6$file, return_data_params)
param_list <- t(matrix(unlist(param_list), nrow=length(unlist(param_list[1]))))

n_6$true_n <- param_list[ ,1]
n_6$true_K <- param_list[,2]
n_6$x_bar <- param_list[,3]
n_6$y_bar <- param_list[,4]
n_6$gamma <- param_list[,5]

hill <- rbind(n_1, n_2, n_3, n_4, n_5, n_6)
```

```{r}
#the result of the last chunk is written here.
#write.csv(hill, "hill-function-batch.csv", row.names = FALSE)
hill <- fread("hill-function-batch.csv")

#filtering the data to produce intended heatmaps
hill_5_40 <- hill %>% filter(true_n == 5 & true_K == 70)
hill_stat <- fread("hill-function-statistics.csv")
hill_5_40_2 <- hill_5_40 %>% inner_join(hill_stat, by = c("true_n", "true_K", "x_bar", "y_bar", "gamma"))
design_matrix <- hill_5_40_2 %>% filter(x_bar == 50, y_bar == 50, gamma == 0.1)
hill_5_40_2$x_bar <- factor(hill_5_40_2$x_bar)
hill_5_40_2$y_bar <- factor(hill_5_40_2$y_bar)
hill_5_40_2$gamma <- factor(hill_5_40_2$gamma)
levels(hill_5_40_2$x_bar) <- c("mean of x2 = 10", "mean of x2 = 50", "mean of x2 = 100")
levels(hill_5_40_2$y_bar) <- c("mean of x1 = 10", "mean of x1 = 50", "mean of x1 = 100")
levels(hill_5_40_2$gamma) <- c("beta1 = 0.1", "beta1 = 1", "beta1 = 10")
```

```{r}
library(latex2exp)

#P8
ggplot(hill_5_40_2, aes(n, K, fill = log(abs(error_AB)))) + geom_tile() + scale_fill_gradient(low = "#00416A", high = "white", name = TeX("$\\log{(|Err_2(n,K)|)}$")) + geom_text(aes(y = 0, x = 3, label = paste("Fc = ", round(Fc, digits = 2))), size=2) + facet_grid(y_bar ~ x_bar + gamma) + geom_vline(xintercept = 5) + geom_hline(yintercept = 70) + labs(title = TeX("$Err_2(n,K)$ Faceted By Parameter Values"), x = "Tested Exponent n", y = "Tested K", caption = TeX("$n^* = 5$, $K^* = 70$")) + theme_bw() + theme(text = element_text(size=13), plot.title = element_text(hjust = 0.5)) 

#P9
ggplot(hill_5_40_2, aes(n, K, fill = log(abs(error_BC)))) + geom_tile() + scale_fill_gradient(low = "#00416A", high = "white", name = TeX("$\\log{(|Err_3(n,K)|)}$")) + geom_text(aes(y = 0, x = 3, label = paste("Fc = ", round(Fc, digits = 2))), size=2) + facet_grid(y_bar ~ x_bar + gamma) + geom_vline(xintercept = 5) + geom_hline(yintercept = 70) + labs(title = TeX("$Err_3(n,K)$ Faceted By Parameter Values"), x = "Tested Exponent n", y = "Tested K", caption = TeX("$n^* = 5$, $K^* = 70$")) + theme_bw() + theme(text = element_text(size=13), plot.title = element_text(hjust = 0.5))

design_matrix_line_AB <- design_matrix %>%
  mutate(error = abs(error_AB)) %>%
  group_by(n) %>%
  filter(error == min(error, na.rm = TRUE)) %>%
  mutate(line = "Variance Invariant") %>%
  select(n, K, error, line) %>%
  filter(K < 100)

design_matrix_line_BC <- design_matrix %>%
  mutate(error = abs(error_BC)) %>%
  group_by(n) %>%
  filter(error == min(error, na.rm = TRUE)) %>%
  mutate(line = "Skewness Invariant") %>%
  select(n, K, error, line) %>%
  filter(K < 100)

design_matrix_lines_inner <- inner_join(design_matrix_line_AB, design_matrix_line_BC, by = c("n", "K"))
design_matrix_lines <- rbind(design_matrix_line_AB, design_matrix_line_BC)
design_matrix_lines <- design_matrix_lines %>% left_join(design_matrix_lines_inner, by = c("n", "K"))
design_matrix_lines$line <- ifelse(is.na(design_matrix_lines$error.y), design_matrix_lines$line, "Intersection")

design_matrix_lines$line <- factor(design_matrix_lines$line, levels = c("Variance Invariant", "Skewness Invariant", "Intersection"))

#P10
ggplot(design_matrix_lines, aes(x = n, y = K, fill = line)) + geom_tile() + scale_fill_manual(values = c("red", "blue", "purple"), name = "Lines") + geom_vline(xintercept = 5) + geom_hline(yintercept = 70) + scale_x_continuous(breaks = seq(0,20)) + labs(title = "Lines of Minimum Error", x = "Tested Exponent n", y = "Tested K", caption = TeX("$n^* = 5$, $K^* = 70$, $<x_1> = 50$, $<x_2> = 50$, $\\beta_1 = 0.1$")) + theme(text = element_text(size=20), axis.text.x = element_text(angle=90, hjust=1), plot.title = element_text(hjust = 0.5))
```

```{r}
# hill <- fread("hill-function-batch.csv")
# hill_5_70 <- hill %>% filter(true_n == 5 & true_K == 70 & x_bar == 50 & y_bar == 50 & gamma == 0.1 & n <= 8 & n >= 3 & K <= 100 & K >= 40)
# hill_stat <- fread("hill-function-statistics.csv")
# hill_5_70_2 <- hill_5_70 %>% inner_join(hill_stat, by = c("true_n", "true_K", "x_bar", "y_bar", "gamma"))
# 
# hill_5_70_2$x_bar <- factor(hill_5_70_2$x_bar)
# hill_5_70_2$y_bar <- factor(hill_5_70_2$y_bar)
# hill_5_70_2$gamma <- factor(hill_5_70_2$gamma)
# levels(hill_5_70_2$x_bar) <- c("mean of x2 = 10", "mean of x2 = 50", "mean of x2 = 100")
# levels(hill_5_70_2$y_bar) <- c("mean of x1 = 10", "mean of x1 = 50", "mean of x1 = 100")
# levels(hill_5_70_2$gamma) <- c("beta1 = 0.1", "beta1 = 1", "beta1 = 10")
# 
# design_matrix_line_AB <- hill_5_70_2 %>%
#   mutate(error = abs(error_AB)) %>%
#   group_by(n) %>%
#   filter(error == min(error, na.rm = TRUE)) %>%
#   mutate(line = "Variance Invariant") %>%
#   select(n, K, error, line) %>%
#   filter(K < 100)
# 
# design_matrix_line_BC <- hill_5_70_2 %>%
#   mutate(error = abs(error_BC)) %>%
#   group_by(n) %>%
#   filter(error == min(error, na.rm = TRUE)) %>%
#   mutate(line = "Skewness Invariant") %>%
#   select(n, K, error, line) %>%
#   filter(K < 100)
# 
# design_matrix_lines <- rbind(design_matrix_line_AB, design_matrix_line_BC)
# hill <- fread("hill-function-batch.csv")
# hill_5_70 <- hill %>% filter(true_n == 5 & true_K == 70 & x_bar == 50 & y_bar == 50 & gamma == 0.1 & n <= 8 & n >= 3 & K <= 100 & K >= 40)
# hill_stat <- fread("hill-function-statistics.csv")
# hill_5_70_2 <- hill_5_70 %>% inner_join(hill_stat, by = c("true_n", "true_K", "x_bar", "y_bar", "gamma"))
# 
# hill_5_70_2$x_bar <- factor(hill_5_70_2$x_bar)
# hill_5_70_2$y_bar <- factor(hill_5_70_2$y_bar)
# hill_5_70_2$gamma <- factor(hill_5_70_2$gamma)
# levels(hill_5_70_2$x_bar) <- c("mean of x2 = 10", "mean of x2 = 50", "mean of x2 = 100")
# levels(hill_5_70_2$y_bar) <- c("mean of x1 = 10", "mean of x1 = 50", "mean of x1 = 100")
# levels(hill_5_70_2$gamma) <- c("beta1 = 0.1", "beta1 = 1", "beta1 = 10")
# 
# design_matrix_line_AB <- hill_5_70_2 %>%
#   mutate(error = abs(error_AB)) %>%
#   group_by(n) %>%
#   filter(error == min(error, na.rm = TRUE)) %>%
#   mutate(line = "Variance") %>%
#   select(n, K, error, line) %>%
#   filter(K < 100)
# 
# design_matrix_line_BC <- hill_5_70_2 %>%
#   mutate(error = abs(error_BC)) %>%
#   group_by(n) %>%
#   filter(error == min(error, na.rm = TRUE)) %>%
#   mutate(line = "Skewness") %>%
#   select(n, K, error, line) %>%
#   filter(K < 100)
# 
# design_matrix_lines <- rbind(design_matrix_line_AB, design_matrix_line_BC)
# 
# design_matrix_lines$line <- factor(design_matrix_lines$line, c("Variance", "Skewness"))
# 
# p1 <- ggplot(design_matrix_lines, aes(x = n, y = K, fill = line)) + geom_tile(alpha = 0.5)+ scale_fill_manual(values = c("red", "blue"), name = "Invariant") + scale_x_continuous(breaks = seq(0,20)) + labs(title = "Lines of Minimum Error from Invariants", x = "Tested n", y = "Tested K", caption = TeX("$n^* = 5$, $K^* = 70$,  $<x_1> = 50$, $<x_2> = 50$, $\\beta_1 = 0.1$")) + theme(text = element_text(size=20), axis.text.x = element_text(angle=90, hjust=1), plot.title = element_text(hjust = 0.5), legend.position="bottom") + geom_hline(yintercept = 70) + geom_vline(xintercept = 5)
# 
# p1
```

```{r}
hill_2 <- hill %>% filter(x_bar == 50 & 1 <= true_n & true_n <= 4 & 30 <= true_K & true_K <= 90)
hill_stat <- read.csv("hill-function-statistics.csv")
hill_3 <- hill_2 %>% inner_join(hill_stat, by = c("true_n", "true_K", "x_bar", "y_bar", "gamma"))

hill_3$true_n_fac <- factor(hill_3$true_n)
hill_3$true_K_fac <- factor(hill_3$true_K)
levels(hill_3$true_n_fac) <- c("true n = 1", "true n = 2", "true n = 3", "true n = 4")
levels(hill_3$true_K_fac) <- c("true K = 30", "true K = 50", "true K = 70", "true K = 90")

#P14
ggplot(hill_3, aes(n, K, fill = log(abs(error_AB)))) + geom_tile() + scale_fill_gradient(low = "red", high = "white", name = TeX("$\\log{(|Err_2(n,K)|)}$")) + facet_grid(true_n_fac ~ true_K_fac) + labs(title = TeX("$Err_2(n,K)$ Faceted By Parameter Values"), x = "Tested Exponent n", y = "Tested K", caption = TeX("$<x_1> = 50$, $<x_2> = 50$, $\\beta_1 = 0.1$")) + theme_bw() + theme(text = element_text(size=20), plot.title = element_text(hjust = 0.5)) + geom_hline(aes(yintercept = true_K)) + geom_vline(aes(xintercept = true_n))

#P16
ggplot(hill_3, aes(n, K, fill = log(abs(error_BC)))) + geom_tile() + scale_fill_gradient(low = "blue", high = "white", name = TeX("$\\log{(|Err_3(n,K)|)}$")) + facet_grid(true_n_fac ~ true_K_fac) + labs(title = TeX("$Err_3(n,K)$ Faceted By Parameter Values"), x = "Tested Exponent n", y = "Tested K", caption = TeX("$<x_1> = 50$, $<x_2> = 50$, $\\beta_1 = 0.1$")) + theme_bw() + theme(text = element_text(size=20), plot.title = element_text(hjust = 0.5)) + geom_hline(aes(yintercept = true_K)) + geom_vline(aes(xintercept = true_n))
```

```{r}
hill_2 <- hill %>% filter(true_n == 5 & true_K == 70 & x_bar == 50)
hill_stat <- read.csv("hill-function-statistics.csv")
hill_3 <- hill_2 %>% inner_join(hill_stat, by = c("true_n", "true_K", "x_bar", "y_bar", "gamma"))

hill_3$y_bar_fac <- factor(hill_3$y_bar)
hill_3$gamma_fac <- factor(hill_3$gamma)
levels(hill_3$y_bar_fac) <- c("mean of x1 = 10", "mean of x1 = 50", "mean of x1 = 100")
levels(hill_3$gamma_fac) <- c("beta1 = 0.1", "beta1 = 1", "beta1 = 10")

#P15
ggplot(hill_3, aes(n, K, fill = log(abs(error_AB)))) + geom_tile() + scale_fill_gradient(low = "red", high = "white", name = TeX("$\\log{(|Err_2(n,K)|)}$")) + facet_grid(y_bar_fac ~ gamma_fac) + labs(title = TeX("$Err_2(n,K)$ Faceted By Parameter Values"), x = "Tested Exponent n", y = "Tested K", caption = TeX("$n^* = 5$, $K^* = 70$, $<x_2> = 50$")) + theme_bw() + theme(text = element_text(size=20), plot.title = element_text(hjust = 0.5)) + geom_hline(aes(yintercept = true_K)) + geom_vline(aes(xintercept = true_n))

#P17
ggplot(hill_3, aes(n, K, fill = log(abs(error_BC)))) + geom_tile() + scale_fill_gradient(low = "blue", high = "white", name = TeX("$\\log{(|Err_3(n,K)|)}$")) + facet_grid(y_bar_fac ~ gamma_fac) + labs(title = TeX("$Err_3(n,K)$ Faceted By Parameter Values"), x = "Tested Exponent n", y = "Tested K", caption = TeX("$n^* = 5$, $K^* = 70$, $<x_2> = 50$")) + theme_bw() + theme(text = element_text(size=20), plot.title = element_text(hjust = 0.5)) + geom_hline(aes(yintercept = true_K)) + geom_vline(aes(xintercept = true_n))
```


